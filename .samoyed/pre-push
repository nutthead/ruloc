#!/bin/sh
# Pre-push hook for ruloc
# Runs comprehensive checks before allowing push to remote
#
# Bypass: SAMOYED=0 git push
# Debug: SAMOYED=2 git push

set -e

echo "ğŸš€ Running pre-push checks..."

# Check if cargo is available
if ! command -v cargo >/dev/null 2>&1; then
    echo "âŒ Error: cargo not found in PATH"
    exit 1
fi

# 1. Run all tests
echo "  â”œâ”€ Running tests..."
if ! cargo test --all-features; then
    echo "âŒ Tests failed!"
    echo "ğŸ’¡ Fix failing tests before pushing"
    exit 1
fi
echo "  â”‚  âœ“ All tests passed"

# 2. Check if cargo-tarpaulin is installed
if command -v cargo-tarpaulin >/dev/null 2>&1; then
    echo "  â”œâ”€ Checking code coverage..."

    # Run tarpaulin and capture output
    if ! cargo tarpaulin --skip-clean --out Stdout 2>&1 | tee /tmp/tarpaulin-output.txt; then
        echo "âŒ Coverage check failed to run!"
        exit 1
    fi

    # Extract coverage percentage from output
    coverage=$(grep -oP '\d+\.\d+%' /tmp/tarpaulin-output.txt | tail -1 | tr -d '%' || echo "0")
    min_coverage=70.0

    # Use awk for floating point comparison
    if ! awk -v cov="$coverage" -v min="$min_coverage" 'BEGIN { exit !(cov >= min) }'; then
        echo "âŒ Coverage check failed!"
        echo "   Current: ${coverage}%, Required: ${min_coverage}%"
        echo "ğŸ’¡ Add tests to improve coverage"
        rm -f /tmp/tarpaulin-output.txt
        exit 1
    fi

    echo "  â”‚  âœ“ Coverage: ${coverage}% (â‰¥ ${min_coverage}%)"
    rm -f /tmp/tarpaulin-output.txt
else
    echo "  â”œâ”€ âš ï¸  cargo-tarpaulin not installed, skipping coverage check"
    echo "  â”‚  ğŸ’¡ Install with: cargo install cargo-tarpaulin"
fi

# 3. Build in release mode
echo "  â””â”€ Building release binary..."
if ! cargo build --release --all-features; then
    echo "âŒ Release build failed!"
    exit 1
fi
echo "     âœ“ Release build successful"

echo "âœ… Pre-push checks passed!"
exit 0
