# ============================================================================
# release-plz Configuration
# ============================================================================
# Automated release management with smart version bumping and changelog
# generation based on conventional commits.
#
# Features:
# - Automatic PR creation with version bumps
# - Changelog generation using git-cliff
# - Dependency updates
# - Workspace support (single crate in this case)
# - GitHub release creation

[workspace]
# Dependency update strategy: Manual updates preferred for reproducible builds
# Set to false to align with --locked flags in CI/release workflows
dependencies_update = false

# Allow dirty working directory (useful for CI)
allow_dirty = false

# Update the changelog using the git-cliff template
changelog_update = true

# PR body template
pr_body = """
## ğŸš€ Release PR{% if releases | length == 1 %} for v{{ releases[0].next_version }}{% endif %}

This PR was automatically created by [release-plz](https://github.com/MarcoIeni/release-plz) and contains:

### ğŸ“¦ Version Updates
{% for r in releases -%}
- **{{ r.package }}**: `{{ r.previous_version }}` â†’ `{{ r.next_version }}`
{% endfor %}
{% for r in releases -%}
{% if r.changelog | default(value="") | trim | length > 0 %}
### ğŸ“ Changelog for {{ r.package }}
{{ r.changelog }}
{% endif %}
{%- if r.breaking_changes | default(value="") | trim | length > 0 %}
### âš ï¸ Breaking Changes in {{ r.package }}
{{ r.breaking_changes }}
{% endif %}
{%- endfor %}
### âœ… Checklist
- [ ] Version bump looks correct
- [ ] Changelog entries are accurate
- [ ] All CI checks pass
- [ ] Breaking changes are properly documented

### ğŸ”„ Merge Instructions
When you merge this PR, the following will happen automatically:
1. New git tags will be created:
{% for r in releases -%}
   - `v{{ r.next_version }}` for {{ r.package }}
{% endfor -%}
2. GitHub release will be published with binaries
3. The crate will be published to crates.io
4. Attestations and signatures will be generated

---
*This is an automated PR. Please review carefully before merging.*
"""

# ============================================================================
# Package-specific configuration
# ============================================================================
[[package]]
name = "ruloc"
changelog_path = "CHANGELOG.md"
publish = true
release = true
git_release_enable = true  # Explicitly enable GitHub release creation

# ============================================================================
# Changelog configuration powered by git-cliff
# ============================================================================
[changelog]
header = """
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).
"""

body = """
{% if version -%}
## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else -%}
## [Unreleased]
{% endif -%}
{% for group, commits in commits | group_by(attribute="group") %}
### {{ group | upper_first }}
{% for commit in commits -%}
- {% if commit.breaking %}[**breaking**] {% endif %}{{ commit.message | upper_first | trim }}{% if commit.github.username %} by @{{ commit.github.username }}{% endif %}
{% endfor -%}
{% endfor -%}
{% if version and previous.version -%}
[{{ version | trim_start_matches(pat="v") }}]: https://github.com/nutthead/ruloc/compare/{{ previous.version }}..{{ version }}
{% endif -%}

<!-- generated by release-plz + git-cliff -->
"""

trim = true
protect_breaking_commits = true
# Match stable tags like v1.2.3 and ignore pre-release suffixes
tag_pattern = "^v\\d+\\.\\d+\\.\\d+$"
sort_commits = "oldest"
commit_preprocessors = [
    # Convert issue/PR references to clickable hyperlinks
    # Examples:
    #   (fix #123) â†’ ([#123](https://github.com/nutthead/ruloc/issues/123))
    #   (closes #456) â†’ ([#456](https://github.com/nutthead/ruloc/issues/456))
    #   (#789) â†’ ([#789](https://github.com/nutthead/ruloc/issues/789))
    #
    # Note: Links to /issues/ endpoint which GitHub redirects to /pull/ for PRs
    # This provides full traceability while keeping changelogs clean
    { pattern = '\\((\\w+\\s)?#([0-9]+)\\)', replace = "([#${2}](https://github.com/nutthead/ruloc/issues/${2}))" },
]
commit_parsers = [
    # ========================================================================
    # Skip Rules (highest priority - evaluated first)
    # ========================================================================
    # Commits with $no-changelog tag are excluded from changelog
    # Example: "feat: Add feature\n\n$feat, $no-changelog"
    { body = ".*\\$no-changelog", skip = true },

    # ========================================================================
    # Primary Classification: Tag-based Grouping
    # ========================================================================
    # /c command generates commits with footer tags like "$type" or "$type, $no-changelog"
    # Format: "type[(scope)]: description\n\nbody\n\n$type"
    # The $type tag determines the changelog category (takes precedence over subject line)
    { body = ".*\\$feat", group = "â­ Features" },
    { body = ".*\\$fix", group = "ğŸ› Bug Fixes" },
    { body = ".*\\$docs", group = "ğŸ“š Documentation" },
    { body = ".*\\$perf", group = "âš¡ Performance" },
    { body = ".*\\$refactor", group = "ğŸ”¨ Refactor" },
    { body = ".*\\$style", group = "ğŸ¨ Styling" },
    { body = ".*\\$test", group = "ğŸ§ª Testing" },
    { body = ".*\\$build", group = "ğŸ“¦ Build System" },
    { body = ".*\\$ci", group = "ğŸ‘· CI/CD" },
    { body = ".*\\$revert", group = "âª Reverts" },
    { body = ".*\\$chore", group = "ğŸ§¹ Miscellaneous" },
    { body = ".*\\$misc", group = "ğŸ§¹ Miscellaneous" },

    # ========================================================================
    # Special Case: Security-related commits
    # ========================================================================
    { body = ".*security", group = "ğŸ” Security" },

    # ========================================================================
    # Fallback: Message-based Grouping (for commits without footer tags)
    # ========================================================================
    # These rules classify commits based on subject line prefix when no $tag present
    # Format: "type[(scope)]: description"
    { message = "^feat", group = "â­ Features" },
    { message = "^fix", group = "ğŸ› Bug Fixes" },
    { message = "^docs?", group = "ğŸ“š Documentation" },
    { message = "^perf", group = "âš¡ Performance" },
    { message = "^refactor", group = "ğŸ”¨ Refactor" },
    { message = "^style", group = "ğŸ¨ Styling" },
    { message = "^test", group = "ğŸ§ª Testing" },
    { message = "^build", group = "ğŸ“¦ Build System" },
    { message = "^ci", group = "ğŸ‘· CI/CD" },
    { message = "^revert", group = "âª Reverts" },
    { message = "^chore", group = "ğŸ§¹ Miscellaneous" },
    { message = "^misc", group = "ğŸ§¹ Miscellaneous" },

    # ========================================================================
    # Catch-all (lowest priority)
    # ========================================================================
    { message = ".*", group = "ğŸ§¹ Miscellaneous" },
]
